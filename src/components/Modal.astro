---
import { projects } from "@cv";
const { url } = Astro.props;
const { Icono } = Astro.props;

const { name } = Astro.props;
const project = projects.find((item) => item.name === name);

const { Tipo } = Astro.props;
const isModal = Tipo === "Eye";
const isLink = Tipo === "NewPage";
---

<!-- Tipo -->
  { isModal && (
  <button data-abrir={`modal-${name}`} class="button">
    <Icono />
  </button>
  )}
  { isLink && (
  <a
    href={url}
    target="_blank"
    title={`Ir al proyecto ${name}`}
    class="button"
  >
    <Icono />
  </a> 
  )}
<!-- Modal -->
  <dialog class="dialog-content" id={`modal-${name}`}>
    <div class="modal-content">
      <button data-cerrar={`modal-${name}`}>Cerrar</button>
      <p>Nombre corto: {name}</p>
      <p>{project?.description}</p>
    </div>
  </dialog>

<script>
  import { gsap } from "gsap";
  /////////////// Funciones ///////////////////////
  // Función para calcular el origen de la animación basado en la posición del botón
  const calcularOrigen = (boton: HTMLElement, dialog: HTMLDialogElement) => {
    const rect = boton.getBoundingClientRect();
    const origenX = rect.left + rect.width / 2;
    const origenY = rect.top + rect.height / 2;

    const dialogRect = dialog.getBoundingClientRect();
    const ox = ((origenX - dialogRect.left) / dialogRect.width) * 100;
    const oy = ((origenY - dialogRect.top) / dialogRect.height) * 100;

    return `${ox}% ${oy}%`;
  };
  // Función para cerrar el modal con animación
  const cerrarDialog = (dialog: HTMLDialogElement) => {
    const modalId = dialog.id;
    const boton = document.querySelector(`[data-abrir="${modalId}"]`) as HTMLElement;
    const origin = boton ? calcularOrigen(boton, dialog) : "50% 50%";
    gsap.to(dialog, {
      scale: 0,
      opacity: 0,
      duration: 0.25,
      ease: "power2.in",
      transformOrigin: origin,
      onComplete: () => {
        dialog.close();
        gsap.set(dialog, { clearProps: "all" });
      },
    });
  };
  /////////////// Manejo apertura y cierre ///////////////////////
  // Abrir
  document.querySelectorAll("[data-abrir]").forEach((btn) => {
    btn.addEventListener("click", (event) => {
      const boton = event.currentTarget as HTMLElement;
      const modalId = boton.getAttribute("data-abrir");
      const dialog = document.getElementById(modalId) as HTMLDialogElement;
      dialog.showModal();
      
      const origin = calcularOrigen(boton, dialog);
      gsap.fromTo(
        dialog,
        { scale: 0, opacity: 0, transformOrigin: origin },
        { scale: 1, opacity: 1, duration: 0.4, ease: "back.out(1.7)", transformOrigin: origin }
      );
      // Guarda coordenadas
      dialog.dataset.botonOrigen = boton.getAttribute("data-abrir") ?? "";
    });
  });
  // Cerrar con botón
  document.querySelectorAll("[data-cerrar]").forEach((btn) => {
    btn.addEventListener("click", (event) => {
      const modalId = (event.currentTarget as HTMLElement).getAttribute( "data-cerrar");
      const dialog = document.getElementById(modalId) as HTMLDialogElement;
      if (dialog) cerrarDialog(dialog);
    });
  });
  // Cerrar al clicar fuera
  document.querySelectorAll("dialog").forEach((dialog) => {
    dialog.addEventListener("click", (e) => {
      if (e.target === dialog) cerrarDialog(dialog as HTMLDialogElement);
    });
  });
</script>

<style>
  dialog {
     font-size: 1rem;
     font-weight: normal;
     font-family: Lucida Console, monospace;
     max-width: 400px;
     border: none;
     border-radius: 8px;
     letter-spacing: normal;
     line-height: normal;
  }
  .modal-content {
    padding: 2rem;
  }
  dialog::backdrop {
    backdrop-filter: blur(0.7px);
  }
  .button {
    margin-bottom: 15px;
    margin-left: auto;
    border: none;
    background-color: transparent;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
  }
  .button:hover {
    border-radius: 4px;
    background: #f9f9f9;
  }
</style>
